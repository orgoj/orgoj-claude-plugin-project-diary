# Project Diary Plugin

A Claude Code plugin for project-local session diaries with reflection to CLAUDE.md.

## Features

- **Project-local storage**: Diary entries stored in `./.claude/diary/` (not global)
- **Session ID tracking**: Multiple Claude sessions can run without conflicts
- **Automatic recovery**: PreCompact/SessionEnd hooks parse transcript and generate recovery files
- **Context restoration**: After compact, previous recovery content is loaded into context
- **Manual diary**: `/diary` command for structured session documentation
- **Intelligent reflection**: `/reflect` analyzes patterns and updates CLAUDE.md

## Installation

```bash
# Add marketplace
/plugin marketplace add orgoj/orgoj-claude-plugin-project-diary

# Install plugin
/plugin install project-diary@orgoj-project-diary

# Restart Claude Code
```

## Usage

### /diary [FILEPATH]

Create a diary entry from the current session.

```bash
# Manual diary (auto-generates filename)
/diary

# With specific filepath (used by hooks)
/diary ./.claude/diary/2025-12-31-14-30-abc123.md
```

**Diary location**: `./.claude/diary/YYYY-MM-DD-HH-MM-SESSIONID.md`

### /reflect [PARAMS]

Analyze diary entries and update CLAUDE.md.

```bash
# Default: last 10 unprocessed entries
/reflect

# Last N entries
/reflect last 20 entries

# Date range
/reflect from 2025-01-01 to 2025-01-31

# Last N days
/reflect last 7 days

# Filter by keyword
/reflect related to React

# Combine filters
/reflect last 5 entries related to testing

# Include already processed entries
/reflect include processed

# Reprocess specific entry
/reflect reprocess 2025-01-01-10-30-abc123.md
```

## How It Works

### Hooks

| Event | Action |
|-------|--------|
| SessionStart | Outputs session ID to context (`<session-info>`) |
| SessionStart (after compact) | Also loads previous recovery into context (`<recovery-context>`) |
| PreCompact | Creates recovery file before context compaction |
| SessionEnd | Creates recovery file when session ends |

### Data Flow

```
SessionStart → outputs SESSION_ID to context
PreCompact/SessionEnd → hook parses transcript → generates recovery markdown
SessionStart (compact) → loads previous recovery into context
Manual /diary → Claude writes diary (uses SESSION_ID from context)
```

### Recovery vs Diary

| Type | Location | Generated by | Purpose |
|------|----------|--------------|---------|
| **Recovery** | `.claude/diary/recovery/` | Hooks (auto) | Context restoration after compact |
| **Diary** | `.claude/diary/` | `/diary` command (manual) | Structured session documentation |

### Recovery Content (auto-generated)

Extracted from transcript JSONL:
- **What Was Asked**: User prompts
- **Task State**: TodoWrite status (completed/in-progress/pending)
- **Files Modified**: From Edit/Write tool calls
- **Recent Actions**: Last 10 tool calls with status
- **Errors**: Bash failures and errors
- **Last Context**: Last assistant message (truncated)

### Pattern Recognition

`/reflect` identifies:
- **Strong patterns** (3+ occurrences) → Added to CLAUDE.md
- **Emerging patterns** (2 occurrences) → Added to CLAUDE.md
- **One-off observations** → Noted but not added

## Directory Structure

```
your-project/
├── .claude/
│   └── diary/
│       ├── 2025-12-31-14-30-abc123.md    # Manual diary (/diary command)
│       ├── 2025-12-31-16-45-def456.md
│       ├── processed.log                  # Tracks analyzed entries
│       ├── recovery/                      # Auto-generated (hooks)
│       │   ├── 2025-12-31-14-00-abc123.md
│       │   └── 2025-12-31-16-00-def456.md
│       └── reflections/
│           └── 2025-12-reflection-1.md    # Reflection documents
└── CLAUDE.md                              # Updated by /reflect
```

## Requirements

- Claude Code CLI
- Node.js (for transcript parsing)
- `jq` (for JSON processing in hooks)

## Credits

Inspired by:
- [claude-diary](https://github.com/rlancemartin/claude-diary) by rlancemartin
- [Continuous-Claude-v2](https://github.com/parcadei/Continuous-Claude-v2) - transcript parsing approach

Key differences from claude-diary:
- Project-local instead of global storage
- Session ID in filenames for multi-session support
- Auto-generated diary from transcript (no Claude call needed)
- Plugin format (just install, no manual setup)

## License

MIT
