# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Claude Code plugin that provides project-local session diaries with automatic recovery after context compaction and reflection to CLAUDE.md.

## Architecture

```
hooks/
├── hooks.json           # Hook definitions (SessionStart, PreCompact, SessionEnd, Stop, UserPromptSubmit)
├── diary-hook.sh        # Bash dispatcher - routes events to appropriate handlers
├── time-tracker.sh      # Idle time detection - tracks time between responses
└── recovery-generator.js # Node.js transcript parser - generates recovery markdown

commands/
├── diary.md             # /diary skill - manual session documentation
├── diary-config.md      # /diary-config skill - configure recovery settings
└── reflect.md           # /reflect skill - pattern analysis and CLAUDE.md updates
```

### Data Flow

1. **SessionStart** → `diary-hook.sh session-start` → outputs `<session-info>` with SESSION_ID
2. **PreCompact/SessionEnd** → `diary-hook.sh pre-compact|session-end` → calls `recovery-generator.js`
3. **recovery-generator.js** → parses JSONL transcript → writes `.claude/diary/recovery/*.md`
4. **SessionStart (after compact)** → loads previous recovery into `<recovery-context>`
5. **Stop** → `time-tracker.sh stop` → saves timestamp to `.claude/diary/timestamps/{SESSION_ID}.txt`
6. **UserPromptSubmit** → `time-tracker.sh prompt` → checks idle time, injects note if threshold exceeded

### Transcript Parsing (recovery-generator.js)

Parses Claude Code's JSONL transcript format:
- Entry structure: `{ type: "user"|"assistant", message: { role, content } }`
- User messages: `content` is string (prompts) or array (tool_result)
- Assistant messages: `content` is array of `{ type: "text"|"tool_use", ... }`
- Tool results link via `tool_use_id` to original `tool_use` blocks

### Storage Locations

| Type | Location | Generated By |
|------|----------|--------------|
| Recovery | `.claude/diary/recovery/` | Hooks (automatic) |
| Timestamps | `.claude/diary/timestamps/` | Stop hook (automatic) |
| Manual Diary | `.claude/diary/` | `/diary` command |
| Processed Diary | `.claude/diary/processed/` | `/reflect` command (moved after analysis) |
| Reflections | `.claude/diary/reflections/` | `/reflect` command |
| Config | `.claude/diary/.config.json` | `/diary-config` command |

### Configuration

Recovery generator and idle time detection can be configured via `.claude/diary/.config.json`:

```json
{
  "recovery": {
    "minActivity": 1,
    "limits": {
      "userPrompts": 5,
      "promptLength": 150,
      "toolCalls": 10,
      "lastMessageLength": 500,
      "errors": 5
    }
  },
  "idleTime": {
    "enabled": false,
    "thresholdMinutes": 5
  }
}
```

**Recovery Settings:**
- **minActivity**: Minimum activity score (prompts + toolCalls + files + todos) to generate recovery. Sessions below this threshold are skipped.
- **limits**: Control how much data is saved in recovery files.

**Idle Time Detection:**
- **enabled**: Enable/disable idle time tracking (default: true)
- **thresholdMinutes**: Minutes of idle time between Stop and UserPromptSubmit before notification is injected

Use `/diary-config` to create config interactively.

## Development

### Testing Hooks

```bash
# Test session start output
echo '{"session_id":"test123","cwd":"/tmp","source":"startup"}' | bash hooks/diary-hook.sh --project-dir "/tmp" session-start

# Test recovery generation (requires transcript)
echo '{"session_id":"test123","cwd":"/tmp","transcript_path":"/path/to/transcript.jsonl"}' | node hooks/recovery-generator.js

# Test idle time tracking
echo '{"session_id":"test456"}' | bash hooks/time-tracker.sh --project-dir "/tmp" stop
cat /tmp/.claude/diary/timestamps/test456.txt
```

### Requirements

- Node.js (for recovery-generator.js)
- jq (for JSON parsing in diary-hook.sh)

## Plugin Conventions

- Filename format: `YYYY-MM-DD-HH-MM-SESSIONID.md`
- Recovery files append with separator when same session compacts multiple times
- Hook outputs use XML tags (`<session-info>`, `<recovery-context>`) for parsing

## User Preferences

- version: bump + CHANGELOG update must be in same commit as feature
- README: update feature documentation when behavior changes, not just versions
- commands: dev workflow tools go in `.claude/commands/`, plugin features go in `commands/`
- skills: read description carefully before invoking, match to actual task
- commits: conventional format (feat:, fix:, chore:) with English messages
- push: wait for explicit user confirmation before pushing
- worktrees: do NOT use git worktrees for this project - work directly on master
