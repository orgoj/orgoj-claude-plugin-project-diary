# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Claude Code plugin that provides project-local session diaries with automatic recovery after context compaction and reflection to CLAUDE.md.

## Architecture

**Master of Prompts (mopc)** - Single cross-platform Zig binary with zero runtime dependencies (except SessionStart hook which requires Node.js runtime provided by Claude Code).

```
bin/
└── mopc                 # Symlink to zig-out/bin/mopc (for direct CLI usage)

hooks/
├── hooks.json           # Hook definitions (SessionStart, PreCompact, SessionEnd, Stop, UserPromptSubmit)
├── mopc                 # Symlink to zig-out/bin/mopc (used by hooks)
└── session-start.js     # Node.js script for SessionStart hook (platform detection & setup)

zig-out/bin/             # Pre-compiled binaries for all platforms
├── linux-x64/mopc
├── linux-arm64/mopc
├── darwin-x64/mopc      # macOS Intel
├── darwin-arm64/mopc    # macOS Apple Silicon
└── windows-x64/mopc.exe

src/
├── main.zig             # Main entry point - command dispatcher
├── commands/
│   ├── recovery.zig     # Native JSONL transcript parser - generates recovery markdown
│   ├── hook.zig         # Hook handler - session-start, pre-compact, session-end
│   ├── tracker.zig      # Time tracker - stop, prompt events
│   ├── wrapper.zig      # Wrapper implementation (bin/claude-diary)
│   ├── debug.zig        # Debug CLI - enable/disable/view/clear
│   └── debug_hook.zig   # Catch-all hook handler for debug logging
└── shared/
    ├── config.zig       # Configuration loading with cascade
    ├── paths.zig        # Path utilities
    └── debug.zig        # Debug logging module

scripts/
└── build-all-platforms.sh  # Cross-compile for all platforms

commands/
├── diary.md             # /diary skill - manual session documentation
├── diary-config.md      # /diary-config skill - configure recovery settings
└── reflect.md           # /reflect skill - pattern analysis and CLAUDE.md updates
```

**Note on SessionStart Hook:**
- SessionStart hook MUST use Node.js (session-start.js) because it runs before mopc symlink exists
- Creates the `hooks/mopc` symlink pointing to correct platform binary
- Claude Code provides Node.js runtime (compatible with Bun if used as Node.js replacement)
- All other hooks use the mopc binary directly via symlink

### Data Flow

**Wrapper Flow (bin/claude-diary):**
1. Generates unique SESSION_ID
2. Checks unprocessed diaries → offers/auto `/reflect` in separate session
3. Runs `claude code --session-id $SESSION_ID` (main interactive session)
4. After session ends → offers/auto `/diary` via `--resume $SESSION_ID`

**Hook Flow:**
1. **SessionStart** → `hooks/diary-hook.sh` (symlink) → `bin/mopc-wrapper` → platform binary `mopc hook session-start` → outputs `<session-info>`
2. **PreCompact/SessionEnd** → wrapper selects platform binary → `mopc recovery`
3. **mopc recovery** (native Zig) → parses JSONL transcript → writes `.claude/diary/recovery/*.md`
4. **SessionStart (after compact)** → loads previous recovery into `<recovery-context>`
5. **Stop** → `hooks/time-tracker.sh` (symlink) → wrapper → `mopc tracker stop` → saves timestamp
6. **UserPromptSubmit** → wrapper → `mopc tracker prompt` → checks idle time, injects note if threshold exceeded

### Transcript Parsing (src/commands/recovery.zig)

Pure Zig implementation that parses Claude Code's JSONL transcript format:
- Entry structure: `{ type: "user"|"assistant", message: { role, content } }`
- User messages: `content` is string (prompts) or array (tool_result)
- Assistant messages: `content` is array of `{ type: "text"|"tool_use", ... }`
- Tool results link via `tool_use_id` to original `tool_use` blocks
- No Node.js dependency - fully native Zig implementation

### Storage Locations

| Type | Location | Generated By |
|------|----------|--------------|
| Recovery | `.claude/diary/recovery/` | Hooks (automatic) |
| Timestamps | `.claude/diary/timestamps/` | Stop hook (automatic) |
| Manual Diary | `.claude/diary/` | `/diary` command |
| Processed Diary | `.claude/diary/processed/` | `/reflect` command (moved after analysis) |
| Reflections | `.claude/diary/reflections/` | `/reflect` command |
| Config | `.claude/diary/.config.json` | `/diary-config` command |

### Configuration

**Config Cascade System:**

Configurations are loaded and merged in hierarchical order:

1. **Home config** (`~/.config/mopc/config.json`) - Global defaults
2. **Intermediate configs** (`.mopc-config.json` files in parent directories) - Per-workspace/organization settings
3. **Project config** (`.claude/diary/.config.json`) - Project-specific overrides

Example hierarchy:
```
~/.config/mopc/config.json           # home: recovery.minActivity = 2
~/work/.mopc-config.json             # work: wrapper.autoDiary = true
~/work/wdt/.mopc-config.json         # wdt: wrapper.minSessionSize = 30
~/work/wdt/projekty/                 # no config (inherits from wdt)
~/work/wdt/projekty/project1/.claude/diary/.config.json  # project overrides
```

Configs are merged field-by-field, with later configs overriding earlier ones. Missing files are skipped gracefully.

**Config Format:**

Recovery generator, idle time detection, and wrapper behavior can be configured:

```json
{
  "recovery": {
    "minActivity": 1,
    "limits": {
      "userPrompts": 5,
      "promptLength": 150,
      "toolCalls": 10,
      "lastMessageLength": 500,
      "errors": 5
    }
  },
  "idleTime": {
    "enabled": true,
    "thresholdMinutes": 5
  },
  "wrapper": {
    "autoDiary": false,
    "autoReflect": false,
    "askBeforeDiary": true,
    "askBeforeReflect": true,
    "minSessionSize": 2,
    "minDiaryCount": 1
  }
}
```

**Claude Execution Settings:**
- **cmd**: Command to execute (default: "claude")
- **env**: Environment variables for Claude execution
  - Literal values: `"MY_VAR": "value"`
  - References: `"PATH": "$PATH:/custom"` (expands from current environment)
  - Unset: `"REMOVE_VAR": null` (removes variable)
- **tmux**: Optional tmux session name (wrapper detects and uses tmux if available)
- **override**: Per-command overrides for `reflect`, `main`, and `diary` invocations

Example Claude config:
```json
{
  "claude": {
    "cmd": "happy",
    "env": {
      "API_KEY": "$HOME_API_KEY",
      "DEBUG": null
    },
    "tmux": "cc-main",
    "override": {
      "reflect": {
        "cmd": "claude",
        "tmux": "cc-reflect"
      }
    }
  }
}
```

**Recovery Settings:**
- **minActivity**: Minimum activity score (prompts + toolCalls + files + todos) to generate recovery. Sessions below this threshold are skipped.
- **limits**: Control how much data is saved in recovery files.

**Idle Time Detection:**
- **enabled**: Enable/disable idle time tracking (default: true)
- **thresholdMinutes**: Minutes of idle time between Stop and UserPromptSubmit before notification is injected

**Wrapper Settings (for bin/claude-diary):**
- **autoDiary**: Automatically run `/diary` at session end without prompting (default: false)
- **autoReflect**: Automatically run `/reflect` when unprocessed diaries found (default: false)
- **askBeforeDiary**: Show prompt before running `/diary` (default: true)
- **askBeforeReflect**: Show prompt before running `/reflect` (default: true)
- **minSessionSize**: Minimum transcript size in KB to offer diary (default: 2)
- **minDiaryCount**: Minimum number of diary files to offer reflect (default: 1)

Use `/diary-config` to create/update config interactively.

**Wrapper CLI Options:**
```bash
bin/claude-diary [WRAPPER_OPTIONS] -- [CLAUDE_OPTIONS]

Wrapper options (before --):
  --min-session-size N    Minimum session size in KB (default: 2)
  --min-diary-count N     Minimum diary count for reflect (default: 1)
  --auto-diary            Force auto-diary mode
  --auto-reflect          Force auto-reflect mode
  --                      Separator (all args after go to Claude CLI)

Examples:
  bin/claude-diary --min-session-size 10 -- --model sonnet
  bin/claude-diary --min-diary-count 3 --auto-reflect -- "fix bug"
```

## Usage

### Direct Claude CLI (manual diary)
```bash
claude code           # Normal session
# Use /diary manually at end
```

### Wrapper (automatic diary management)
```bash
bin/claude-diary      # Session with auto diary prompts
# Detects unprocessed → offers /reflect
# At end → offers /diary in same session
```

The wrapper uses `--session-id` and `--resume` to maintain context across commands.

## Development

### Building

```bash
# Build for all platforms (Linux, macOS, Windows)
./scripts/build-all-platforms.sh

# Or build for current platform only
zig build

# Outputs: zig-out/bin/{platform}/mopc[.exe]
```

### Testing Wrapper
```bash
# Test wrapper with auto-reflect disabled
bin/claude-diary

# Test with custom args
bin/claude-diary --model sonnet "fix the bug"
```

### Testing Hooks

```bash
# Build first
zig build

# Test session start output
echo '{"session_id":"test123","cwd":"/tmp","source":"startup"}' | bash hooks/diary-hook.sh --project-dir "/tmp" session-start

# Test recovery generation (requires transcript)
echo '{"session_id":"test123","cwd":"/tmp","transcript_path":"/path/to/transcript.jsonl"}' | zig-out/bin/mopc recovery

# Test idle time tracking
echo '{"session_id":"test456"}' | bash hooks/time-tracker.sh --project-dir "/tmp" stop
cat /tmp/.claude/diary/timestamps/test456.txt

# Test config cascade
zig-out/bin/mopc test-config /path/to/project
```

### Requirements

**For End Users (plugin installation):**
- None! Pre-compiled binaries included for all platforms

**For Development:**
- Zig 0.13.0+ (for building/modifying mopc binary)

### Runtime Dependencies Explained

**Why Node.js for SessionStart Hook:**

The SessionStart hook (`hooks/session-start.js`) is the ONLY component that requires Node.js runtime:

1. **Execution Context:**
   - SessionStart runs BEFORE any plugin files are set up
   - At this point, the `hooks/mopc` symlink doesn't exist yet
   - Cannot use mopc binary for platform detection

2. **What SessionStart Does:**
   - Detects platform (Linux/macOS/Windows) and architecture (x64/arm64)
   - Creates `hooks/mopc` symlink pointing to correct platform binary in `zig-out/bin/{platform}/mopc`
   - Returns `<session-info>` XML for Claude to parse

3. **Node.js Runtime Source:**
   - Claude Code includes **bundled Node.js runtime** in installation
   - When hook executes `node hooks/session-start.js`, it uses Claude Code's internal Node.js
   - **Users DO NOT need to install Node.js separately**
   - The bundled runtime is isolated from system Node.js

4. **Bun Compatibility:**
   - If user has Bun installed, Claude Code can use it as Node.js replacement
   - Bun is Node.js-compatible and can run session-start.js
   - This is optional - Claude Code's bundled Node.js is sufficient

5. **Why Not Zig for SessionStart:**
   - Would require separate Zig binary for platform detection
   - Node.js is already available in Claude Code (zero additional dependencies for users)
   - Simpler to maintain single-file JavaScript for this bootstrap task

**All Other Hooks:**
- Use mopc binary directly via symlink (after SessionStart creates it)
- Pure Zig with zero runtime dependencies
- No Node.js, Bash, or external tools required

## Plugin Conventions

- Filename format: `YYYY-MM-DD-HH-MM-SESSIONID.md`
- Recovery files append with separator when same session compacts multiple times
- Hook outputs use XML tags (`<session-info>`, `<recovery-context>`) for parsing
- Wrapper generates 8-char session IDs and creates temporary `.claude/settings.local.json` for permissions

## Version Tracking & Migration Strategy

**Current Status:** No version tracking in files (pre-1.0)

**Future Strategy (when making breaking changes):**

When introducing incompatible changes to file formats, implement version tracking:

1. **Config Files** (`.claude/diary/.config.json`):
   ```json
   {
     "version": "2.0.0",
     "recovery": {...},
     "debug": {...}
   }
   ```
   - mopc reads `version` field
   - If missing or old: automatic migration or warning
   - Migration function: `config.migrate(from_version, to_version)`

2. **Recovery Files** (`.claude/diary/recovery/*.md`):
   ```markdown
   <!-- mopc-version: 2.0.0 -->
   # Session Recovery
   ...
   ```
   - Add version comment at top of file
   - mopc checks version when loading recovery
   - Old format: continue working or show migration notice

3. **Debug Log** (`.claude/diary/debug/hooks.jsonl`):
   ```json
   {"version":"2.0.0","timestamp":...}
   ```
   - Each log entry includes version
   - Backward compatible parsing (skip unknown fields)

**Implementation Guidelines:**
- Add version tracking ONLY when introducing breaking changes
- Provide migration path or clear error messages
- Document version changes in CHANGELOG.md
- Keep backward compatibility when possible

**Version Detection:**
- mopc knows its own version (src/main.zig: `v1.14.0`)
- Compare mopc version with file version
- Warn if file version > mopc version (newer format)
- Migrate if file version < mopc version (older format)

## User Preferences

- version: bump + CHANGELOG update must be in same commit as feature
- README: update feature documentation when behavior changes, not just versions
- commands: dev workflow tools go in `.claude/commands/`, plugin features go in `commands/`
- skills: read description carefully before invoking, match to actual task
- commits: conventional format (feat:, fix:, chore:) with English messages
- push: wait for explicit user confirmation before pushing
- worktrees: do NOT use git worktrees for this project - work directly on master

## Feature Completion Checklist

After implementing any major feature (non-trivial change that affects user-facing functionality), complete ALL steps in a SINGLE commit:

1. **Version Bump** (`src/main.zig`)
   - Increment version appropriately (major.minor.patch)
   - Major: Breaking changes or significant new features
   - Minor: New features, significant improvements
   - Patch: Bug fixes, small improvements

2. **CHANGELOG.md Update**
   - Add new version section at the top with current date
   - Categorize changes: Added, Changed, Fixed, Removed
   - Include usage examples for new features
   - Be specific about what changed and why

3. **README.md Update**
   - Add/update feature documentation
   - Include usage examples and configuration
   - Update command list if new commands added
   - Update feature list in introduction if applicable

4. **Commit Message**
   - Use conventional format: `feat:`, `fix:`, `chore:`
   - Include detailed description in commit body
   - Reference what was implemented

5. **Push**
   - Wait for explicit user confirmation before pushing

**Example commit structure:**
```
feat: implement comprehensive hook debug logging system

Added two-level debug logging for hook execution:
[detailed description...]

Changes:
- Version: 1.12.0 → 1.13.0
- Updated CHANGELOG.md with v1.13.0 section
- Updated README.md with Debug Logging section
```
