# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Claude Code plugin that provides project-local session diaries with automatic recovery after context compaction and reflection to CLAUDE.md.

## Architecture

```
hooks/
├── hooks.json           # Hook definitions (SessionStart, PreCompact, SessionEnd)
├── diary-hook.sh        # Bash dispatcher - routes events to appropriate handlers
└── recovery-generator.js # Node.js transcript parser - generates recovery markdown

commands/
├── diary.md             # /diary skill - manual session documentation
└── reflect.md           # /reflect skill - pattern analysis and CLAUDE.md updates
```

### Data Flow

1. **SessionStart** → `diary-hook.sh session-start` → outputs `<session-info>` with SESSION_ID
2. **PreCompact/SessionEnd** → `diary-hook.sh pre-compact|session-end` → calls `recovery-generator.js`
3. **recovery-generator.js** → parses JSONL transcript → writes `.claude/diary/recovery/*.md`
4. **SessionStart (after compact)** → loads previous recovery into `<recovery-context>`

### Transcript Parsing (recovery-generator.js)

Parses Claude Code's JSONL transcript format:
- Entry structure: `{ type: "user"|"assistant", message: { role, content } }`
- User messages: `content` is string (prompts) or array (tool_result)
- Assistant messages: `content` is array of `{ type: "text"|"tool_use", ... }`
- Tool results link via `tool_use_id` to original `tool_use` blocks

### Storage Locations

| Type | Location | Generated By |
|------|----------|--------------|
| Recovery | `.claude/diary/recovery/` | Hooks (automatic) |
| Manual Diary | `.claude/diary/` | `/diary` command |
| Processed Diary | `.claude/diary/processed/` | `/reflect` command (moved after analysis) |
| Reflections | `.claude/diary/reflections/` | `/reflect` command |

## Development

### Testing Hooks

```bash
# Test session start output
echo '{"session_id":"test123","cwd":"/tmp","source":"startup"}' | bash hooks/diary-hook.sh session-start

# Test recovery generation (requires transcript)
echo '{"session_id":"test123","cwd":"/tmp","transcript_path":"/path/to/transcript.jsonl"}' | node hooks/recovery-generator.js
```

### Requirements

- Node.js (for recovery-generator.js)
- jq (for JSON parsing in diary-hook.sh)

## Plugin Conventions

- Filename format: `YYYY-MM-DD-HH-MM-SESSIONID.md`
- Recovery files append with separator when same session compacts multiple times
- Hook outputs use XML tags (`<session-info>`, `<recovery-context>`) for parsing

## User Preferences

- version: bump + CHANGELOG update must be in same commit as feature
- README: update feature documentation when behavior changes, not just versions
- commands: dev workflow tools go in `.claude/commands/`, plugin features go in `commands/`
- skills: read description carefully before invoking, match to actual task
- commits: conventional format (feat:, fix:, chore:) with English messages
- push: wait for explicit user confirmation before pushing
