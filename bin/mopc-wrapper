#!/bin/bash
# Platform detection wrapper for mopc
# Selects the correct pre-compiled binary based on OS and architecture

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Detect OS
case "$(uname -s)" in
    Linux*)
        OS="linux"
        ;;
    Darwin*)
        OS="darwin"
        ;;
    MINGW*|MSYS*|CYGWIN*)
        OS="windows"
        ;;
    *)
        echo "Error: Unsupported operating system: $(uname -s)" >&2
        exit 1
        ;;
esac

# Detect architecture
case "$(uname -m)" in
    x86_64|amd64)
        ARCH="x64"
        ;;
    aarch64|arm64)
        ARCH="arm64"
        ;;
    *)
        echo "Error: Unsupported architecture: $(uname -m)" >&2
        exit 1
        ;;
esac

# Determine platform and executable extension
PLATFORM="${OS}-${ARCH}"
EXT=""
if [ "$OS" = "windows" ]; then
    EXT=".exe"
fi

# Path to platform-specific binary
MOPC_BIN="$PLUGIN_ROOT/zig-out/bin/$PLATFORM/mopc$EXT"

# Check if binary exists
if [ ! -f "$MOPC_BIN" ]; then
    echo "Error: mopc binary not found for platform $PLATFORM" >&2
    echo "Expected: $MOPC_BIN" >&2
    echo "" >&2
    echo "Available binaries:" >&2
    find "$PLUGIN_ROOT/zig-out/bin" -type f -name "mopc*" 2>/dev/null || echo "  (none found)" >&2
    exit 1
fi

# Make sure binary is executable
chmod +x "$MOPC_BIN" 2>/dev/null || true

# Execute the platform-specific binary with all arguments
# Call the 'wrapper' subcommand (for bin/claude-diary)
exec "$MOPC_BIN" wrapper "$@"
