#!/usr/bin/env node
/**
 * mopc - Master of Prompts CLI
 * Cross-platform wrapper for mopc binary
 */

const fs = require('fs');
const path = require('path');
const { spawnSync } = require('child_process');

// Detect platform
const platformMap = {
  linux: 'linux',
  darwin: 'darwin',
  win32: 'windows'
};

const archMap = {
  x64: 'x64',
  arm64: 'arm64'
};

const os = platformMap[process.platform];
const arch = archMap[process.arch];

if (!os || !arch) {
  console.error(`Unsupported platform: ${process.platform} ${process.arch}`);
  process.exit(1);
}

const platform = `${os}-${arch}`;
const ext = os === 'windows' ? '.exe' : '';

// Paths
const pluginRoot = path.resolve(__dirname, '..');

// Prefer dev build if exists, otherwise use platform-specific
const devBin = path.join(pluginRoot, 'zig-out', 'bin', `mopc${ext}`);
const prodBin = path.join(pluginRoot, 'zig-out', 'bin', platform, `mopc${ext}`);

let mopcBin;
if (fs.existsSync(devBin)) {
  mopcBin = devBin;
} else if (fs.existsSync(prodBin)) {
  mopcBin = prodBin;
} else {
  console.error(`Error: mopc binary not found`);
  console.error(`Tried dev: ${devBin}`);
  console.error(`Tried prod: ${prodBin}`);
  console.error('');
  console.error('Run one of:');
  console.error('  zig build                         # Dev build');
  console.error('  ./scripts/build-all-platforms.sh  # All platforms');
  process.exit(1);
}

// Call mopc binary with all arguments
const args = process.argv.slice(2);
const result = spawnSync(mopcBin, args, {
  stdio: 'inherit',
  cwd: process.cwd()
});

process.exit(result.status || 0);
